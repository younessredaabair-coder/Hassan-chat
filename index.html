<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RubiChat | Ø±ÙˆØ¨ÙŠ Ø´Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap');
        
        :root {
            --primary-glass: rgba(20, 0, 5, 0.65);
            --secondary-glass: rgba(255, 255, 255, 0.08);
            --accent-red: #ef4444;
            --accent-gradient: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            --msg-me: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
        }

        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #050101; 
            margin: 0; 
            overflow: hidden; 
            color: #fff;
            background-image: radial-gradient(circle at 50% 50%, #2a0a0a 0%, #000000 100%);
        }

        /* Glassmorphism Classes */
        .glass-panel { 
            background: var(--primary-glass); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 68, 68, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            border-color: var(--accent-red);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.3);
        }

        /* Messages */
        .msg-me { 
            background: var(--msg-me); 
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2); 
            border-bottom-left-radius: 1.2rem;
            border-top-left-radius: 1.2rem;
            border-top-right-radius: 0;
            border-bottom-right-radius: 1.2rem;
        }
        .msg-friend { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            border-bottom-left-radius: 1.2rem;
            border-top-left-radius: 0;
            border-top-right-radius: 1.2rem;
            border-bottom-right-radius: 1.2rem;
        }

        /* Chat Background Pattern */
        .chat-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        .active-user-item {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.2) 0%, transparent 100%) !important;
            border-right: 3px solid #ef4444;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-red); }

        /* Custom Audio Player hidden */
        audio { display: none; }

        .checkmark { font-size: 0.65rem; margin-right: 2px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen relative w-full selection:bg-red-500 selection:text-white">

    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-red-900 rounded-full mix-blend-screen filter blur-[120px] opacity-40 animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-red-800 rounded-full mix-blend-screen filter blur-[130px] opacity-30 animate-float" style="animation-delay: -3s;"></div>
    </div>

    <audio id="snd-send" src="https://cdn.pixabay.com/audio/2022/11/22/audio_febc508520.mp3"></audio>
    <audio id="snd-receive" src="https://cdn.pixabay.com/audio/2022/03/15/audio_7366f076b1.mp3"></audio>

    <div class="w-full h-[100dvh] md:h-[95dvh] md:w-[96%] max-w-[1500px] md:rounded-[2rem] glass-panel flex overflow-hidden relative z-10">
        
        <aside id="sidebar" class="sidebar w-80 h-full border-l border-white/5 flex flex-col absolute md:relative z-30 transition-all duration-300 bg-[#0f0202]/90 backdrop-blur-xl md:bg-transparent -right-full md:right-0">
            <div class="p-5 border-b border-white/5 flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 cursor-pointer group" onclick="openSettingsModal()">
                        <div class="relative shrink-0">
                            <img id="myAvatar" src="" class="w-12 h-12 rounded-full border-2 border-red-500/50 object-cover shadow-[0_0_15px_rgba(239,68,68,0.3)] group-hover:scale-105 transition">
                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-black"></div>
                        </div>
                        <div class="overflow-hidden">
                            <h1 class="text-base font-bold truncate text-white group-hover:text-red-400 transition" id="myNameDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
                            <p class="text-[10px] text-red-200/60 truncate bg-red-500/10 inline-block px-2 py-0.5 rounded mt-0.5 font-mono" id="myIdDisplay"></p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><i class="fas fa-times"></i></button>
                        <button onclick="openSettingsModal()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 text-slate-300 flex items-center justify-center transition"><i class="fas fa-cog"></i></button>
                        <button onclick="openAddModal()" class="w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center transition shadow-lg shadow-red-600/20"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚..." class="w-full glass-input px-4 py-2 rounded-xl text-sm text-white placeholder-slate-500 outline-none pl-10">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-500 text-xs"></i>
                </div>
            </div>

            <div id="contactList" class="flex-1 overflow-y-auto px-2 py-2 space-y-1 scroll-smooth">
                </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative w-full bg-black/40 chat-pattern">
            
            <header class="h-[70px] border-b border-white/5 flex items-center justify-between px-4 md:px-6 bg-black/20 backdrop-blur-md z-20">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden w-9 h-9 rounded-full bg-white/5 flex items-center justify-center text-slate-200"><i class="fas fa-bars"></i></button>
                    
                    <div id="headerContent" class="hidden items-center gap-3 animate-in fade-in slide-in-from-left-2">
                        <div class="relative">
                            <img id="activeChatAvatar" src="" class="w-10 h-10 rounded-full border border-white/10">
                            <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border border-black"></span>
                        </div>
                        <div class="flex flex-col">
                            <h2 id="activeChatName" class="font-bold text-sm md:text-base text-white"></h2>
                            <p class="text-[10px] text-slate-400" id="statusText">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                        </div>
                    </div>
                </div>
                
                <div id="headerActions" class="hidden gap-3 text-slate-400">
                    <button class="hover:text-red-400 transition"><i class="fas fa-phone"></i></button>
                    <button class="hover:text-red-400 transition"><i class="fas fa-video"></i></button>
                    <button class="hover:text-red-400 transition"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </header>

            <div id="chatBox" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 z-10 scroll-smooth relative">
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center px-4">
                    <div class="w-28 h-28 mb-6 rounded-full bg-gradient-to-br from-red-900/40 to-black flex items-center justify-center border border-red-500/20 shadow-[0_0_30px_rgba(220,38,38,0.1)]">
                        <i class="fas fa-gem text-5xl text-red-500/80"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ RubiChat</h3>
                    <p class="text-slate-400 max-w-sm text-sm leading-relaxed opacity-80">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø¯Ø«Ø© Ø¢Ù…Ù†ØŒ Ø£Ù†ÙŠÙ‚ØŒ ÙˆÙ…Ù†Ø·Ù‚ÙŠ. Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡.</p>
                </div>
            </div>

            <div id="emojiBar" class="hidden bg-black/60 backdrop-blur-xl border-t border-white/5 p-2 gap-2 overflow-x-auto whitespace-nowrap px-4">
                <span onclick="insertEmoji('ğŸ˜‚')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ˜‚</span>
                <span onclick="insertEmoji('â¤ï¸')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">â¤ï¸</span>
                <span onclick="insertEmoji('ğŸ‘')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ‘</span>
                <span onclick="insertEmoji('ğŸ”¥')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ”¥</span>
                <span onclick="insertEmoji('ğŸ¤”')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ¤”</span>
                <span onclick="insertEmoji('ğŸ‰')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ‰</span>
                <span onclick="insertEmoji('ğŸ˜­')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ˜­</span>
                <span onclick="insertEmoji('ğŸŒ¹')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸŒ¹</span>
                <span onclick="insertEmoji('ğŸ˜')" class="cursor-pointer text-xl hover:scale-125 transition inline-block">ğŸ˜</span>
            </div>

            <footer class="p-3 md:p-5 z-20">
                <form id="msgForm" class="max-w-4xl mx-auto relative flex items-end gap-2 bg-[#1a0505]/80 border border-white/10 p-2 rounded-[1.5rem] backdrop-blur-xl shadow-2xl transition-all duration-300 opacity-50 pointer-events-none" id="footerArea">
                    
                    <button type="button" onclick="toggleEmojiBar()" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-yellow-400 transition shrink-0 hover:bg-white/5">
                        <i class="far fa-grin text-xl"></i>
                    </button>
                    
                    <label class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-blue-400 transition shrink-0 cursor-pointer hover:bg-white/5">
                        <i class="fas fa-paperclip text-lg"></i>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </label>

                    <textarea id="userInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." class="flex-1 bg-transparent border-none text-white px-2 py-2.5 text-sm md:text-base outline-none resize-none max-h-32 placeholder-slate-500/70" disabled></textarea>
                    
                    <button type="submit" id="sendBtn" disabled class="w-11 h-11 shrink-0 rounded-full bg-slate-700 text-slate-400 flex items-center justify-center transition-all duration-300 transform scale-90">
                        <i class="fas fa-paper-plane text-sm translate-x-[-1px] translate-y-[1px]"></i>
                    </button>
                </form>
            </footer>
        </main>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[200] p-4 opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 transition-transform duration-300 bg-[#1a0505]">
            <h3 class="text-xl font-bold mb-6 text-center text-white">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="space-y-4 mb-6">
                <input type="text" id="friendIdInput" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµØ¯ÙŠÙ‚ (Ù…Ø«Ø§Ù„: user_xyz)" class="w-full glass-input px-4 py-3 rounded-xl text-white outline-none">
                <input type="text" id="friendNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØµØ¯ÙŠÙ‚" class="w-full glass-input px-4 py-3 rounded-xl text-white outline-none">
            </div>
            <div class="flex gap-3">
                <button onclick="saveFriend()" class="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-white transition-all">Ø¥Ø¶Ø§ÙØ©</button>
                <button onclick="closeModal('addModal')" class="w-1/3 bg-white/5 hover:bg-white/10 py-3 rounded-xl font-bold text-slate-300">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[200] p-4 opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 transition-transform duration-300 bg-[#1a0505]">
            <h3 class="text-xl font-bold mb-6 text-center text-white">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <div class="flex justify-center mb-4">
                <img id="settingsAvatar" src="" class="w-20 h-20 rounded-full border-4 border-red-500/30">
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-xs text-slate-400 px-2">Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¸Ø§Ù‡Ø±</label>
                    <input type="text" id="myNewName" class="w-full glass-input px-4 py-3 rounded-xl text-white outline-none mt-1">
                </div>
                <div class="bg-black/30 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-black/50 transition" onclick="copyMyId()">
                    <div>
                        <p class="text-xs text-slate-400">Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
                        <p class="text-sm font-mono text-red-300" id="settingsIdDisplay">...</p>
                    </div>
                    <i class="far fa-copy text-slate-400"></i>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="saveProfile()" class="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-white transition-all">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <button onclick="closeModal('settingsModal')" class="w-1/3 bg-white/5 hover:bg-white/10 py-3 rounded-xl font-bold text-slate-300">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBAd90iD0cwzhKfWtMlu45wOki3YlkJVM8",
        authDomain: "ai-gpt-1daf3.firebaseapp.com",
        databaseURL: "https://ai-gpt-1daf3-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "ai-gpt-1daf3",
        storageBucket: "ai-gpt-1daf3.firebasestorage.app",
        messagingSenderId: "674946918449",
        appId: "1:674946918449:web:9440001fb72c7f2bb10d10"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
    let myName = localStorage.getItem('rubi_user_name') || "Ø¶ÙŠÙ";
    let myId = localStorage.getItem('rubi_user_id');

    if (!myId) {
        myId = 'u' + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('rubi_user_id', myId);
        myName = prompt("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ RubiChat! Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹:") || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯";
        localStorage.setItem('rubi_user_name', myName);
    }

    function updateUserInfoUI() {
        document.getElementById('myNameDisplay').innerText = myName;
        document.getElementById('myIdDisplay').innerText = `@${myId}`;
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(myName)}&background=991b1b&color=fff&rounded=true&bold=true`;
        document.getElementById('myAvatar').src = avatarUrl;
        document.getElementById('settingsAvatar').src = avatarUrl;
        document.getElementById('settingsIdDisplay').innerText = myId;
        document.getElementById('myNewName').value = myName;
    }
    updateUserInfoUI();

    window.copyMyId = () => {
        navigator.clipboard.writeText(myId);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: " + myId);
    }

    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let currentFriendId = null;
    let friendsData = [];

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI Logic) ---
    window.toggleSidebar = () => {
        const sb = document.getElementById('sidebar');
        sb.classList.toggle('-right-full');
        sb.classList.toggle('right-0');
    }

    window.openAddModal = () => showModal('addModal');
    window.openSettingsModal = () => showModal('settingsModal');
    window.closeModal = (id) => hideModal(id);

    function showModal(id) {
        const modal = document.getElementById(id);
        modal.classList.replace('hidden', 'flex');
        setTimeout(() => {
            modal.classList.replace('opacity-0', 'opacity-100');
            modal.querySelector('div').classList.replace('scale-95', 'scale-100');
        }, 10);
    }

    function hideModal(id) {
        const modal = document.getElementById(id);
        modal.classList.replace('opacity-100', 'opacity-0');
        modal.querySelector('div').classList.replace('scale-100', 'scale-95');
        setTimeout(() => modal.classList.replace('flex', 'hidden'), 300);
    }

    window.saveProfile = () => {
        const newName = document.getElementById('myNewName').value.trim();
        if(newName) {
            myName = newName;
            localStorage.setItem('rubi_user_name', myName);
            updateUserInfoUI();
            closeModal('settingsModal');
        }
    };

    window.toggleEmojiBar = () => {
        const bar = document.getElementById('emojiBar');
        bar.classList.toggle('hidden');
        bar.classList.toggle('flex');
    };

    window.insertEmoji = (emoji) => {
        const input = document.getElementById('userInput');
        input.value += emoji;
        input.focus();
    };

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø« ---
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.friend-item');
        items.forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            item.style.display = name.includes(val) ? 'flex' : 'none';
        });
    });

    window.saveFriend = () => {
        const fid = document.getElementById('friendIdInput').value.trim();
        const fname = document.getElementById('friendNameInput').value.trim();
        if(fid && fname) {
            if(fid === myId) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ!"); return; }
            set(ref(db, `users/${myId}/friends/${fid}`), { name: fname, id: fid });
            closeModal('addModal');
            document.getElementById('friendIdInput').value = '';
            document.getElementById('friendNameInput').value = '';
        }
    };

    window.deleteFriend = (e, id) => {
        e.stopPropagation();
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) {
            remove(ref(db, `users/${myId}/friends/${id}`));
            if(currentFriendId === id) resetChat();
        }
    };

    onValue(ref(db, `users/${myId}/friends`), (snapshot) => {
        const list = document.getElementById('contactList');
        list.innerHTML = '';
        friendsData = [];
        
        if (!snapshot.exists()) {
            list.innerHTML = '<p class="text-center text-slate-500 text-xs mt-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</p>';
            return;
        }

        snapshot.forEach(child => {
            const f = child.val();
            friendsData.push(f);
            const isActive = currentFriendId === f.id ? 'active-user-item' : '';
            
            list.innerHTML += `
                <div class="friend-item flex items-center justify-between p-3 rounded-xl hover:bg-white/5 transition cursor-pointer group ${isActive}" 
                     data-name="${f.name}" 
                     id="friend-${f.id}"
                     onclick="selectFriend('${f.id}', '${f.name}')">
                    <div class="flex items-center gap-3">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(f.name)}&background=random&color=fff&rounded=true" class="w-10 h-10 rounded-full">
                        <div>
                            <h4 class="text-sm font-bold text-slate-200">${f.name}</h4>
                            <p class="text-[10px] text-slate-500">Ø§Ù†Ù‚Ø± Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                        </div>
                    </div>
                    <button onclick="deleteFriend(event, '${f.id}')" class="text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                </div>
            `;
        });
    });

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ---
    function getChatId(id1, id2) { return [id1, id2].sort().join('_'); }

    window.selectFriend = (id, name) => {
        currentFriendId = id;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.querySelectorAll('.friend-item').forEach(el => el.classList.remove('active-user-item'));
        const activeEl = document.getElementById(`friend-${id}`);
        if(activeEl) activeEl.classList.add('active-user-item');

        document.getElementById('welcomeScreen').classList.add('hidden');
        document.getElementById('headerContent').classList.remove('hidden');
        document.getElementById('headerContent').classList.add('flex');
        document.getElementById('headerActions').classList.remove('hidden');
        document.getElementById('headerActions').classList.add('flex');
        
        document.getElementById('activeChatName').innerText = name;
        document.getElementById('activeChatAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&rounded=true`;

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        const form = document.getElementById('msgForm');
        form.classList.remove('opacity-50', 'pointer-events-none');
        form.classList.add('opacity-100');
        
        const input = document.getElementById('userInput');
        const btn = document.getElementById('sendBtn');
        input.disabled = false;
        btn.disabled = false;
        btn.className = "w-11 h-11 shrink-0 rounded-full bg-red-600 hover:bg-red-500 text-white flex items-center justify-center transition-all duration-300 shadow-[0_0_15px_rgba(239,68,68,0.4)]";
        input.focus();

        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.remove('right-0');
            document.getElementById('sidebar').classList.add('-right-full');
        }

        loadMessages(id);
    };

    function resetChat() {
        currentFriendId = null;
        document.getElementById('welcomeScreen').classList.remove('hidden');
        document.getElementById('headerContent').classList.add('hidden');
        document.getElementById('headerContent').classList.remove('flex');
        document.getElementById('chatBox').innerHTML = document.getElementById('welcomeScreen').outerHTML;
        
        const form = document.getElementById('msgForm');
        form.classList.add('opacity-50', 'pointer-events-none');
        document.getElementById('userInput').value = '';
    }

    function loadMessages(fId) {
        const box = document.getElementById('chatBox');
        const chatId = getChatId(myId, fId);
        
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø³Ø§Ø¨Ù‚ÙŠÙ† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± (ØªØ¨Ø³ÙŠØ·Ø§Ù‹ Ù„Ù„ÙƒÙˆØ¯)
        // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ¬Ø¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ listeners Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„
        
        onValue(ref(db, `conversations/${chatId}`), (snapshot) => {
            if(currentFriendId !== fId) return;
            
            box.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ

            if (!snapshot.exists()) {
                box.innerHTML = `<div class="text-center mt-10 text-slate-500 text-xs bg-black/20 inline-block mx-auto px-4 py-1 rounded-full border border-white/5">Ø¨Ø¯Ø§ÙŠØ© Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø´ÙØ±Ø©</div>`;
                return;
            }

            let lastSender = null;
            
            snapshot.forEach(child => {
                const m = child.val();
                const isMe = m.sender === myId;
                const time = new Date(m.time).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12: false});
                
                // Content logic (Image vs Text)
                let contentHtml = '';
                if(m.type === 'image') {
                    contentHtml = `<img src="${m.content}" class="max-w-full rounded-lg mb-1 border border-white/10" style="max-height: 200px;">`;
                } else {
                    contentHtml = `<p class="text-sm md:text-[15px] leading-relaxed">${m.content}</p>`;
                }

                const tickHtml = isMe ? `<span class="text-blue-300 ml-1 checkmark"><i class="fas fa-check-double"></i></span>` : '';

                box.innerHTML += `
                    <div class="flex ${isMe ? 'justify-start' : 'justify-end'} w-full mb-1 animate-in fade-in slide-in-from-bottom-2 duration-300">
                        <div class="max-w-[80%] md:max-w-[65%] flex flex-col ${isMe ? 'items-start' : 'items-end'}">
                            <div class="p-2 px-3 ${isMe ? 'msg-me text-white' : 'msg-friend text-slate-200'} relative min-w-[80px]">
                                ${contentHtml}
                                <div class="flex items-center justify-end gap-1 mt-0.5 opacity-70">
                                    <span class="text-[9px] font-sans">${time}</span>
                                    ${tickHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Scroll to bottom
            setTimeout(() => box.scrollTop = box.scrollHeight, 50);
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø¨Ø³ÙŠØ·)
            // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ÙŠØ­ØªØ§Ø¬ ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ù… ØªØ­Ù…ÙŠÙ„ Ù‚Ø¯ÙŠÙ…
        });
    }

    // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
    document.getElementById('msgForm').addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage('text');
    });

    document.getElementById('userInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage('text');
        }
    });

    window.handleImageUpload = (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø¨Ø³Ø·) Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ ÙƒÙ€ Base64
                // ØªØ­Ø°ÙŠØ±: Base64 Ø«Ù‚ÙŠÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠÙØ¶Ù„ Firebase Storage Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ù‡Ù†Ø§:
                sendMessage('image', e.target.result);
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    function sendMessage(type, content = null) {
        if(!currentFriendId) return;
        
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        
        let msgData = {};
        
        if(type === 'text' && text) {
            msgData = { sender: myId, type: 'text', content: text, time: Date.now() };
            input.value = '';
        } else if (type === 'image' && content) {
            msgData = { sender: myId, type: 'image', content: content, time: Date.now() };
        } else {
            return;
        }

        push(ref(db, `conversations/${getChatId(myId, currentFriendId)}`), msgData);
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        const snd = document.getElementById('snd-send');
        if(snd) { snd.currentTime = 0; snd.play().catch(e=>{}); }
    }

</script>
</body>
</html>
